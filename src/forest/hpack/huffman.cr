module Forest::Hpack
  class Huffman
    property tree : Node
    property table : Array(Tuple(UInt8, Int32, Int32))

    def initialize(@table : Array(Tuple(UInt8, Int32, Int32)))
      @tree = Node.new

      table.each do |row|
        value, binary, length = row
        tree.add binary, length, value
      end
    end

    def encode(string : String) : Bytes
      bytes = Bytes.new string.bytesize
      offset = k = 0_i32

      string.each_byte do |character|
        _, binary, length = table[character]

        (length - 1_i32).downto 0_i32 do |i|
          j = offset % 8_i32
          k = offset // 8_i32 if 0_i32 == j
          bytes[k] |= 128_i32 >> j if 1_i32 == binary.bit(i)
          offset += 1_i32
        end
      end

      count = (offset / 8.0_f32).ceil.to_i

      # * Padding

      bytes[count - 1_i32] |= 0xff_i32 >> (offset % 8_i32) unless (offset % 8_i32).zero?
      bytes[0_i32, count]
    end

    def decode(bytes : Bytes) : String
      io = IO::Memory.new
      node = tree
      eos_padding = true

      bytes.each do |byte|
        byte_has_value = false
        eos_padding = true

        7_i32.downto(0_i32) do |item|
          if 1_i32 == byte.bit(item)
            node = node.right
          else
            node = node.left
            eos_padding = false
          end

          raise Error.new "node is nil!" unless node

          if value = node.value
            io.write_byte value
            node = tree

            byte_has_value = true
            eos_padding = true
          end
        end

        # (Note: If you do not disable it, it will cause the response decoding to fail)
        # (Note: I don't know why)
        # RFC 7541, section 5.2
        # raise Error.new "Huffman string padding is larger than 7-bits" unless byte_has_value
      end

      # RFC 7541, section 5.2
      raise Error.new "Huffman string padding must use MSB of EOS symbol" unless eos_padding

      io.to_s
    end

    def self.huffman : Huffman
      @@huffman
    end

    # {256_u8,  0b111111111111111111111111111111,  30_i32}, # EOS symbol (Invalid)
    @@huffman = Huffman.new [
      {0_u8, 0b1111111111000, 13_i32},
      {1_u8, 0b11111111111111111011000, 23_i32},
      {2_u8, 0b1111111111111111111111100010, 28_i32},
      {3_u8, 0b1111111111111111111111100011, 28_i32},
      {4_u8, 0b1111111111111111111111100100, 28_i32},
      {5_u8, 0b1111111111111111111111100101, 28_i32},
      {6_u8, 0b1111111111111111111111100110, 28_i32},
      {7_u8, 0b1111111111111111111111100111, 28_i32},
      {8_u8, 0b1111111111111111111111101000, 28_i32},
      {9_u8, 0b111111111111111111101010, 24_i32},
      {10_u8, 0b111111111111111111111111111100, 30_i32},
      {11_u8, 0b1111111111111111111111101001, 28_i32},
      {12_u8, 0b1111111111111111111111101010, 28_i32},
      {13_u8, 0b111111111111111111111111111101, 30_i32},
      {14_u8, 0b1111111111111111111111101011, 28_i32},
      {15_u8, 0b1111111111111111111111101100, 28_i32},
      {16_u8, 0b1111111111111111111111101101, 28_i32},
      {17_u8, 0b1111111111111111111111101110, 28_i32},
      {18_u8, 0b1111111111111111111111101111, 28_i32},
      {19_u8, 0b1111111111111111111111110000, 28_i32},
      {20_u8, 0b1111111111111111111111110001, 28_i32},
      {21_u8, 0b1111111111111111111111110010, 28_i32},
      {22_u8, 0b111111111111111111111111111110, 30_i32},
      {23_u8, 0b1111111111111111111111110011, 28_i32},
      {24_u8, 0b1111111111111111111111110100, 28_i32},
      {25_u8, 0b1111111111111111111111110101, 28_i32},
      {26_u8, 0b1111111111111111111111110110, 28_i32},
      {27_u8, 0b1111111111111111111111110111, 28_i32},
      {28_u8, 0b1111111111111111111111111000, 28_i32},
      {29_u8, 0b1111111111111111111111111001, 28_i32},
      {30_u8, 0b1111111111111111111111111010, 28_i32},
      {31_u8, 0b1111111111111111111111111011, 28_i32},
      {32_u8, 0b010100, 6_i32},
      {33_u8, 0b1111111000, 10_i32},
      {34_u8, 0b1111111001, 10_i32},
      {35_u8, 0b111111111010, 12_i32},
      {36_u8, 0b1111111111001, 13_i32},
      {37_u8, 0b010101, 6_i32},
      {38_u8, 0b11111000, 8_i32},
      {39_u8, 0b11111111010, 11_i32},
      {40_u8, 0b1111111010, 10_i32},
      {41_u8, 0b1111111011, 10_i32},
      {42_u8, 0b11111001, 8_i32},
      {43_u8, 0b11111111011, 11_i32},
      {44_u8, 0b11111010, 8_i32},
      {45_u8, 0b010110, 6_i32},
      {46_u8, 0b010111, 6_i32},
      {47_u8, 0b011000, 6_i32},
      {48_u8, 0b00000, 5_i32},
      {49_u8, 0b00001, 5_i32},
      {50_u8, 0b00010, 5_i32},
      {51_u8, 0b011001, 6_i32},
      {52_u8, 0b011010, 6_i32},
      {53_u8, 0b011011, 6_i32},
      {54_u8, 0b011100, 6_i32},
      {55_u8, 0b011101, 6_i32},
      {56_u8, 0b011110, 6_i32},
      {57_u8, 0b011111, 6_i32},
      {58_u8, 0b1011100, 7_i32},
      {59_u8, 0b11111011, 8_i32},
      {60_u8, 0b111111111111100, 15_i32},
      {61_u8, 0b100000, 6_i32},
      {62_u8, 0b111111111011, 12_i32},
      {63_u8, 0b1111111100, 10_i32},
      {64_u8, 0b1111111111010, 13_i32},
      {65_u8, 0b100001, 6_i32},
      {66_u8, 0b1011101, 7_i32},
      {67_u8, 0b1011110, 7_i32},
      {68_u8, 0b1011111, 7_i32},
      {69_u8, 0b1100000, 7_i32},
      {70_u8, 0b1100001, 7_i32},
      {71_u8, 0b1100010, 7_i32},
      {72_u8, 0b1100011, 7_i32},
      {73_u8, 0b1100100, 7_i32},
      {74_u8, 0b1100101, 7_i32},
      {75_u8, 0b1100110, 7_i32},
      {76_u8, 0b1100111, 7_i32},
      {77_u8, 0b1101000, 7_i32},
      {78_u8, 0b1101001, 7_i32},
      {79_u8, 0b1101010, 7_i32},
      {80_u8, 0b1101011, 7_i32},
      {81_u8, 0b1101100, 7_i32},
      {82_u8, 0b1101101, 7_i32},
      {83_u8, 0b1101110, 7_i32},
      {84_u8, 0b1101111, 7_i32},
      {85_u8, 0b1110000, 7_i32},
      {86_u8, 0b1110001, 7_i32},
      {87_u8, 0b1110010, 7_i32},
      {88_u8, 0b11111100, 8_i32},
      {89_u8, 0b1110011, 7_i32},
      {90_u8, 0b11111101, 8_i32},
      {91_u8, 0b1111111111011, 13_i32},
      {92_u8, 0b1111111111111110000, 19_i32},
      {93_u8, 0b1111111111100, 13_i32},
      {94_u8, 0b11111111111100, 14_i32},
      {95_u8, 0b100010, 6_i32},
      {96_u8, 0b111111111111101, 15_i32},
      {97_u8, 0b00011, 5_i32},
      {98_u8, 0b100011, 6_i32},
      {99_u8, 0b00100, 5_i32},
      {100_u8, 0b100100, 6_i32},
      {101_u8, 0b00101, 5_i32},
      {102_u8, 0b100101, 6_i32},
      {103_u8, 0b100110, 6_i32},
      {104_u8, 0b100111, 6_i32},
      {105_u8, 0b00110, 5_i32},
      {106_u8, 0b1110100, 7_i32},
      {107_u8, 0b1110101, 7_i32},
      {108_u8, 0b101000, 6_i32},
      {109_u8, 0b101001, 6_i32},
      {110_u8, 0b101010, 6_i32},
      {111_u8, 0b00111, 5_i32},
      {112_u8, 0b101011, 6_i32},
      {113_u8, 0b1110110, 7_i32},
      {114_u8, 0b101100, 6_i32},
      {115_u8, 0b01000, 5_i32},
      {116_u8, 0b01001, 5_i32},
      {117_u8, 0b101101, 6_i32},
      {118_u8, 0b1110111, 7_i32},
      {119_u8, 0b1111000, 7_i32},
      {120_u8, 0b1111001, 7_i32},
      {121_u8, 0b1111010, 7_i32},
      {122_u8, 0b1111011, 7_i32},
      {123_u8, 0b111111111111110, 15_i32},
      {124_u8, 0b11111111100, 11_i32},
      {125_u8, 0b11111111111101, 14_i32},
      {126_u8, 0b1111111111101, 13_i32},
      {127_u8, 0b1111111111111111111111111100, 28_i32},
      {128_u8, 0b11111111111111100110, 20_i32},
      {129_u8, 0b1111111111111111010010, 22_i32},
      {130_u8, 0b11111111111111100111, 20_i32},
      {131_u8, 0b11111111111111101000, 20_i32},
      {132_u8, 0b1111111111111111010011, 22_i32},
      {133_u8, 0b1111111111111111010100, 22_i32},
      {134_u8, 0b1111111111111111010101, 22_i32},
      {135_u8, 0b11111111111111111011001, 23_i32},
      {136_u8, 0b1111111111111111010110, 22_i32},
      {137_u8, 0b11111111111111111011010, 23_i32},
      {138_u8, 0b11111111111111111011011, 23_i32},
      {139_u8, 0b11111111111111111011100, 23_i32},
      {140_u8, 0b11111111111111111011101, 23_i32},
      {141_u8, 0b11111111111111111011110, 23_i32},
      {142_u8, 0b111111111111111111101011, 24_i32},
      {143_u8, 0b11111111111111111011111, 23_i32},
      {144_u8, 0b111111111111111111101100, 24_i32},
      {145_u8, 0b111111111111111111101101, 24_i32},
      {146_u8, 0b1111111111111111010111, 22_i32},
      {147_u8, 0b11111111111111111100000, 23_i32},
      {148_u8, 0b111111111111111111101110, 24_i32},
      {149_u8, 0b11111111111111111100001, 23_i32},
      {150_u8, 0b11111111111111111100010, 23_i32},
      {151_u8, 0b11111111111111111100011, 23_i32},
      {152_u8, 0b11111111111111111100100, 23_i32},
      {153_u8, 0b111111111111111011100, 21_i32},
      {154_u8, 0b1111111111111111011000, 22_i32},
      {155_u8, 0b11111111111111111100101, 23_i32},
      {156_u8, 0b1111111111111111011001, 22_i32},
      {157_u8, 0b11111111111111111100110, 23_i32},
      {158_u8, 0b11111111111111111100111, 23_i32},
      {159_u8, 0b111111111111111111101111, 24_i32},
      {160_u8, 0b1111111111111111011010, 22_i32},
      {161_u8, 0b111111111111111011101, 21_i32},
      {162_u8, 0b11111111111111101001, 20_i32},
      {163_u8, 0b1111111111111111011011, 22_i32},
      {164_u8, 0b1111111111111111011100, 22_i32},
      {165_u8, 0b11111111111111111101000, 23_i32},
      {166_u8, 0b11111111111111111101001, 23_i32},
      {167_u8, 0b111111111111111011110, 21_i32},
      {168_u8, 0b11111111111111111101010, 23_i32},
      {169_u8, 0b1111111111111111011101, 22_i32},
      {170_u8, 0b1111111111111111011110, 22_i32},
      {171_u8, 0b111111111111111111110000, 24_i32},
      {172_u8, 0b111111111111111011111, 21_i32},
      {173_u8, 0b1111111111111111011111, 22_i32},
      {174_u8, 0b11111111111111111101011, 23_i32},
      {175_u8, 0b11111111111111111101100, 23_i32},
      {176_u8, 0b111111111111111100000, 21_i32},
      {177_u8, 0b111111111111111100001, 21_i32},
      {178_u8, 0b1111111111111111100000, 22_i32},
      {179_u8, 0b111111111111111100010, 21_i32},
      {180_u8, 0b11111111111111111101101, 23_i32},
      {181_u8, 0b1111111111111111100001, 22_i32},
      {182_u8, 0b11111111111111111101110, 23_i32},
      {183_u8, 0b11111111111111111101111, 23_i32},
      {184_u8, 0b11111111111111101010, 20_i32},
      {185_u8, 0b1111111111111111100010, 22_i32},
      {186_u8, 0b1111111111111111100011, 22_i32},
      {187_u8, 0b1111111111111111100100, 22_i32},
      {188_u8, 0b11111111111111111110000, 23_i32},
      {189_u8, 0b1111111111111111100101, 22_i32},
      {190_u8, 0b1111111111111111100110, 22_i32},
      {191_u8, 0b11111111111111111110001, 23_i32},
      {192_u8, 0b11111111111111111111100000, 26_i32},
      {193_u8, 0b11111111111111111111100001, 26_i32},
      {194_u8, 0b11111111111111101011, 20_i32},
      {195_u8, 0b1111111111111110001, 19_i32},
      {196_u8, 0b1111111111111111100111, 22_i32},
      {197_u8, 0b11111111111111111110010, 23_i32},
      {198_u8, 0b1111111111111111101000, 22_i32},
      {199_u8, 0b1111111111111111111101100, 25_i32},
      {200_u8, 0b11111111111111111111100010, 26_i32},
      {201_u8, 0b11111111111111111111100011, 26_i32},
      {202_u8, 0b11111111111111111111100100, 26_i32},
      {203_u8, 0b111111111111111111111011110, 27_i32},
      {204_u8, 0b111111111111111111111011111, 27_i32},
      {205_u8, 0b11111111111111111111100101, 26_i32},
      {206_u8, 0b111111111111111111110001, 24_i32},
      {207_u8, 0b1111111111111111111101101, 25_i32},
      {208_u8, 0b1111111111111110010, 19_i32},
      {209_u8, 0b111111111111111100011, 21_i32},
      {210_u8, 0b11111111111111111111100110, 26_i32},
      {211_u8, 0b111111111111111111111100000, 27_i32},
      {212_u8, 0b111111111111111111111100001, 27_i32},
      {213_u8, 0b11111111111111111111100111, 26_i32},
      {214_u8, 0b111111111111111111111100010, 27_i32},
      {215_u8, 0b111111111111111111110010, 24_i32},
      {216_u8, 0b111111111111111100100, 21_i32},
      {217_u8, 0b111111111111111100101, 21_i32},
      {218_u8, 0b11111111111111111111101000, 26_i32},
      {219_u8, 0b11111111111111111111101001, 26_i32},
      {220_u8, 0b1111111111111111111111111101, 28_i32},
      {221_u8, 0b111111111111111111111100011, 27_i32},
      {222_u8, 0b111111111111111111111100100, 27_i32},
      {223_u8, 0b111111111111111111111100101, 27_i32},
      {224_u8, 0b11111111111111101100, 20_i32},
      {225_u8, 0b111111111111111111110011, 24_i32},
      {226_u8, 0b11111111111111101101, 20_i32},
      {227_u8, 0b111111111111111100110, 21_i32},
      {228_u8, 0b1111111111111111101001, 22_i32},
      {229_u8, 0b111111111111111100111, 21_i32},
      {230_u8, 0b111111111111111101000, 21_i32},
      {231_u8, 0b11111111111111111110011, 23_i32},
      {232_u8, 0b1111111111111111101010, 22_i32},
      {233_u8, 0b1111111111111111101011, 22_i32},
      {234_u8, 0b1111111111111111111101110, 25_i32},
      {235_u8, 0b1111111111111111111101111, 25_i32},
      {236_u8, 0b111111111111111111110100, 24_i32},
      {237_u8, 0b111111111111111111110101, 24_i32},
      {238_u8, 0b11111111111111111111101010, 26_i32},
      {239_u8, 0b11111111111111111110100, 23_i32},
      {240_u8, 0b11111111111111111111101011, 26_i32},
      {241_u8, 0b111111111111111111111100110, 27_i32},
      {242_u8, 0b11111111111111111111101100, 26_i32},
      {243_u8, 0b11111111111111111111101101, 26_i32},
      {244_u8, 0b111111111111111111111100111, 27_i32},
      {245_u8, 0b111111111111111111111101000, 27_i32},
      {246_u8, 0b111111111111111111111101001, 27_i32},
      {247_u8, 0b111111111111111111111101010, 27_i32},
      {248_u8, 0b111111111111111111111101011, 27_i32},
      {249_u8, 0b1111111111111111111111111110, 28_i32},
      {250_u8, 0b111111111111111111111101100, 27_i32},
      {251_u8, 0b111111111111111111111101101, 27_i32},
      {252_u8, 0b111111111111111111111101110, 27_i32},
      {253_u8, 0b111111111111111111111101111, 27_i32},
      {254_u8, 0b111111111111111111111110000, 27_i32},
      {255_u8, 0b11111111111111111111101110, 26_i32},
    ]
  end
end

require "./huffman/*"
